
<div class="container">
    <h1>メニュー検索</h1>
    <%= search_form_for @q, url: menus_path do |f| %>
        <%= f.label :title_cont, 'メニュー名' %>
        <%= f.search_field :title_cont %>
        <%= f.label :difficulty_level_step_cont, 'レベル' %>
        <%= f.search_field :difficulty_level_step_cont %>
        <br>
        <%= f.submit '検索', class: 'btn btn-primary mt-3' %>
    <% end %>

    <h1 class="mt-5 mb-5">メニュー一覧</h1>
    <table class="table table-striped mt-5">
        <thead class="thead-dark">
            <tr>
                <th scope="col">タイトル</th>
                <th scope="col">ビデオ</th>
                <th scope="col">難易度</th>
                <th scope="col">詳細</th>
            </tr>
        </thead>
        <tbody>
        <% @menus.each do |menu| %>
          <tr>
            <td><%= menu.title %></td>
            <td>
              <% if menu.video.attached? %>
                <video width="320" height="240" controls>
                  <source src="<%= url_for(menu.video) %>" type="video/mp4">
                </video>
              <% end %>
            </td>
            <td><%= menu.difficulty_level.step %></td>
            <td>
              <%= link_to '詳細', menu_path(menu.id), class: 'btn btn-primary' %>
            </td>
            <td>
            <% if user_signed_in? && @favorites.key?(menu.id) %>
              <%= link_to 'お気に入り解除する', favorite_path(id: @favorites[menu.id]), method: :delete, class: 'btn btn-danger favorite-button', data: {menu_id: menu.id, method: 'DELETE'} %>
            <% elsif user_signed_in? %>
              <%= link_to 'お気に入りする', favorites_path(menu_id: menu.id), method: :post, class: 'btn btn-primary favorite-button', data: { menu_id: menu.id, method: 'POST'} %>
            <% end %>
            </td>
          </tr>
        <% end %>
        </tbody>
    </table>
</div>

<script>
  $(document).on('click', '.favorite-button', function(e) {
    e.preventDefault();
    const button = $(this);
    const menuId = button.data('menu-id');
    const url = button.attr('href');
    const method = button.data('method') || 'POST'; // メソッドをdata属性から取得
  
    $.ajax({
      url: url,
      method: method,
      dataType: 'json',
    })
    .done(function(data) {
      if (data.status === 'favorited') {
        button.text('お気に入り解除する').removeClass('btn-primary').addClass('btn-danger');
      } else {
        button.text('お気に入りする').removeClass('btn-danger').addClass('btn-primary');
      }
    })
    .fail(function() {
      alert('エラーが発生しました。');
    });
  });
</script>

